pipeline {
    agent any
    stages {
        stage('Clean') {
            steps {
                deleteDir()
            }
        }
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Import artifacts') {
            steps {
                copyArtifacts(projectName: "get-upgradeable-package-list-TEST");
            }
        }

        stage('Change ssh key permissions') {
            steps {
                sh "chmod 700 ansible/ansible_key"
            }
        }

        stage('Get prod upgradable package list') {
            steps {
                sh "ansible-playbook ./ansible/get-updatable-packages.yml -i ./ansible/inventory/hosts.ini --user=root --private-key=./ansible/ansible_key -e target_environment=prod -e region=JON"
                sh '''#!/bin/bash
                     for f in ansible/server-patching-prod*
                     do
                        (echo '---\nPackages:'; cat $f )> $f.yml
                     done
                '''
            }
        }

        stage('Update (only if they are the same)') {
            when {
                expression {
                    return sh(
                        script: '''#!/bin/bash
                                 for prod in ansible/server-patching-prod*.yml
                                 do
                                    test="${prod/prod/test}"
                                    diff $test $prod
                                 done
                            ''',
                        returnStatus: true
                    ) == 0
                }
            }
            steps {
                sh "ansible-playbook ./ansible/update-servers.yml -i ./ansible/inventory/hosts.ini --user=root --private-key=./ansible/ansible_key -e target_environment=prod -e region=JON"
            }
        }
    }
}
