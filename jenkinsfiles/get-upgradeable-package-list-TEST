pipeline {
    agent any
    options { timestamps () }
    stages {
        stage('Clean') {
            steps {
                deleteDir()
            }
        }
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Create the servers list') {
            steps {
                sh "chmod 600 ansible/ansible_key"
                sh "ansible-playbook ./ansible/get-updatable-packages.yml -i ./ansible/inventory/hosts.ini --user=root --private-key=./ansible/ansible_key -e target_environment=test -e region=JON"
            }
        }

        stage('Archive') {
            steps {
                sh '''#!/bin/bash
                     for f in ansible/server-patching-*
                     do
                        (echo '---\nPackages:'; cat $f )> $f.yml
                     done
                '''
                archiveArtifacts artifacts: 'ansible/server-patching-*.yml'
            }
        }
    }
    post {
        success {
           emailext attachLog: true, attachmentsPattern: 'ansible/server-patching-*.yml',
           to: 'viroide@gmail.com',
           subject: "Should we update this changes in PROD? #${env.BUILD_NUMBER}",
           body: "Build: ${env.BUILD_URL}\nTo validate this changes run this build: ${env.JENKINS_URL}/promote-TEST-to-PROD-servers-update/"
       }
    }
}
